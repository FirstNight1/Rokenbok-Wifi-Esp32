# Rokenbok-Wifi-Esp32

This project aims to replace the mainboards in Rokenbok vehicles with new microcontrollers to enable wifi connectivity for the vehicles, and control over wifi, bluetooth (limited to BLE controllers currently), and across the internet.  It also contains projects for implementing an FPV camera on each vehicle, as well as an overall system manager to orchestrate playing with and managing multiple vehicles.

## Release History:
This project has not yet been released as an official version, and is entirely a work in progress.


## Vehicle hardware conversion - Drive Base
WARNING: This conversion is not designed to be easily reversible.  You will need soldering skills, and a willingness to take your vehicle apart, including potentially damaging it irreparably.  Do not expect to be able to go back to the stock configuration/setup if something goes wrong.  Theoretically all the stock wiring is still there, and/or you could run new wire to the stock motors and vehicle keyway, and attach those back to the stock control board.

If you intend to ever reverse this modification, I would suggest taking thorough pictures of the existing wiring connections on the controller board (pictures will be included as possible from my vehicles in the Vehicle Info folder as well), and carefully de-solder the motor, LED, and key wires from the board, that way they can be re-attached.  For ease of reversal, it may be worthwhile to utilize screw terminal blocks on your breakout and control boards, which will minimize re-soldering needed of the existing small vehicle wires.


1. The Vehicle Info folder contains information and pictures of the vehicles modified so far, more pictures and information will be added as we convert more vehicles.  This information may also be useful for repairs to the vehicle.

Parts used:
2x DRV8833 breakout motor driver boards (generic)
1x SeeedStudio XIAO ESP32-S3 controller board, flashed with Micropython and then the latest RokVehicle release (Instructions included in a Readme.md in RokVehicle)
220ohm 1/4 watt resistors, if the vehicle has LEDs (optional)
1x power switch (optional)
(Wire - suggest 22 or 24ga, mounting tape or glue, solder, and other miscellanious electronics bits may be required)
(This project requires mid-level soldering skills)
2. The hardware above will enable a minimal conversion, that only alters the vehicle drive base to use the new control system.  See below sections if you want to add FPV, or eventually we will likely include instructions for power/battery modifications as well.  Currently, this setup is intended to utilize the stock alkaline batteries, and has also proven able to operate on NiMH rechargeables as well.
3. Navigate to the Vehicle Info page for the vehicle you are looking to modify.  It will contain the mechanical steps and pictures needed to disassemble the vehicle, as well as pictures of the control board.  You will need to desolder ALL wires from the existing control board, and remove that control board.
4. A wiring diagram and list is included on each vehicle information page.  You will need to follow it to determine which wires need to be connected where, and then in the root Vehicle Info folder is also a Drive Modification circuit/connection diagram to show the hookups needed.
  * In general, you will need to connect power and ground from the battery terminals to the controller board and one or two motor driver boards (most vehicles will need two motor driver boards, but may only drive 3 total motors).  I suggest routing the battery positive through a swtich first, pictures of which are on the vehicle page to install unobtrusively protruding into the battery compartment.
  * Next, you will need to make connections between the controller and the motor drivers, consisting of up to eight total control signal wires, depending on the number of motors on the given vehicle.
  * Third, you will connect the existing vehicle motor wiring to the motor drivers, consisting of two input wires per motor, and connecting any now-unconnected casing grounds to other motor casings, or the battery ground.
  * Lastly, you will connect any LEDs or accessories/non-motor functions that may be on the vehicle to remaining controller pins, as shown on the schematic.

5. After completing the hardware modifications, it is important to verify all wiring connections prior to powering on the vehicle.  Take a minute and double check your wiring against the circuit diagrams, and ensure all connections make sense (i.e. you aren't shorting the battery leads together anywhere).
6. Hopefully you flashed the software onto the controller before you put it in the vehicle, otherwise dig up a usb-c cord (right angle ones are available and can be helpful if you glued yourself into a jam) and follow those instructions in the RokVehicle project now.

7. On initial startup of a new vehicle, it will create a Wifi Access Point (AP) that looks like loader-XYZABC.  This network name is the tag for the vehicle, and consists of the vehicle type and it's unique tag.  The default vehicle type is loader, we'll update this shortly.  Connect a phone or computer to the access point.  The default password for the access point is 1234567890.  The vehicle should have an IP address of 192.168.4.1, and should assign your device an IP address of 192.168.4.2.
8. Open Chrome (or an internet browser) on the device, and navigate to http://192.168.4.1, which should load the home page for the vehicle, and show various information about the vehicle.
9. Navigate to the Admin page link in the header, which will take you to a page where you can configure the general settings for the vehicle.  Select the correct vehicle type from the list.  When you select a vehicle type from the list, it will update the tag prefix as well.  I suggest keeping the same vehicle tag, but you can also set a custom vehicle tag if desired, ensure it is unique for each vehicle.  You can also set a "friendly name" for the vehicle, useful to differentiate Power Sweeper 1 and Power Sweeper 2 if you have multiple, for example.  Click save to save your updates.  The change to the AP network name to match the new tag will NOT take effect until the vehicle is rebooted.
10. If you are going to use the AP to control the vehicle, go ahead and reboot it now by turning it off and on, or removing and replacing the batteries, and connect your device to the new AP.  If you plan to connect the vehicle to your home wifi and control it that way, then navigate to the wifi page and enter your wifi details.  By default, the vehicle will use DHCP to connect to this wifi network, though you can set a static IP on this page if needed.  In DHCP mode, you will need to use the tools available on your router, or other network scanning tools to locate the IP address of the vehicle.  I suggest either setting a static IP on the vehicle, or associating a designated IP to it via your router, if available (Setting it to a forced IP on the router also blocks the router from assigning that IP elsewhere, which prevents IP address conflicts.  If setting a static IP on the vehicle, try to use a portion of your subnet that is excluded from the DHCP range on your router).
  * When the vehicle boots up, it will attempt 5 times to connect to the wifi network, if configured.  If the vehicle is unable to connect to the network, it will "fall back" to AP mode, and you will see a network with the tag of the vehicle, just like in step 7.  You can use this to check and correct any errors in the wifi settings.  Or also works great if you travel with the vehicle and want to use it away from your configured network, it will quickly fall into AP mode and you can play with it that way.
NOTE: If you get stuck on a bad wifi network or set a bad static IP or similar, reboot the vehicle 3 times in rapid succession (less than 20 seconds between reboots), and it will force the vehicle into AP mode, so you can connect back and edit the wifi/IP settings.  Note that this will not clear your stored wifi network and credentials, so future reboots will still attempt to connect back to the configured network unless you make edits.
11. The vehicle should now be connected to your network, or you are using it in AP mode.  It's time to configure things for your specific vehicle hardware.  Go to the Motor Config page.  The browser should open a websocket to the vehicle (which emulates how a controller will control the vehicle), and then give a list of the motors present on the vehicle, and some configuration items for each: A motor port number (in case you wired your vehicle different from the schematic), a minimum power per motor (controleld on a scale from 1-65), and a reversed checkbox (used for drive or function motors if they rotate opposite the intended direction for "forward" and "reverse", for example if you forgot to reverse the wiring on one of the drive motors so it's opposite the other, or the sweeper is intaking balls on reverse rather than forward, etc.)
  * Ensure the pinouts for each motor, which should be correct if you followed the schematic (left is motor 1, right is motor 2, etc.)  If these are incorrect, use the dropdowns to reassign the motor numbers, ensuring each motor is a unique motor number.  The pinouts for each motor are also listed for convenience.
  * Test each motor by pressing it's forward or reverse button.  The motor selected should run for 1 second and stop.  If the motor doesn't run at all, verify the motor is hooked up correctly, cross reference the motor driver output and input pins, and ensure the pins connected on the controller board match those on the motor config page.  If the motor tries to run but doesn't turn, up the power setting to 100 and try again.  If the motor still tries to turn but doesn't run, you likely have a bad motor connection, bad motor, stuck or broken gearing, or similar.  In that case, you're likely going to have to resort to opening up the vehicle and cleaning out the area of the motor in question.  This may also be affected by your power source, the controller can run at very low voltages compared to what the motors need, but the motors are powered directly by the voltage from the battery (barring using one of the power mods described below).  Try fresh batteries, or if using NiMH, try alkalines since they're higher voltage, just in case.
  * Once you have confirmed all motors run and thus are associated to the correct motor number/pinout, it's time to configure each one for your specific vehicle, power source, and motor condition.
  * There are two motor types defined on each vehicle. First are "axis" motors, which are always the left and right drive motors, and/or may include certain other motors on some vehicles.  This designation indicates these motors can be controlled by a gamepad axis (joysticks, axis buttons like Z/R on some gamepads, etc.).  The second motor type is "function" motors, which are simple on/off control, usually including like the bed raise on trucks, intake on the street sweeper, and similar.
  * Axis motors have a "Minimum Power" setting.  This will be different based on your source of power, motor age, gearing cleanliness, and other factors, and is used to provide a lower bound for axis-based input for those motors.  The available minimums are 1-65, with a default of 40.  To test these, change the power field to 100, and click forward or reverse.  Adjust the minimum power until the motor runs at a slow speed under load (with the vehicle on its wheelbase for example driving), but doesn't stall out.  On NiMH batteries which are lower voltage, this will likely be a slightly higher number. Alkalines or running with a voltage converter can provide more motor power/speed, so the minimum power number will likely be a little lower, allowing a greater range of control.
    * You may also find you need to re-adjust this setting to compensate for as batteries deplete, and you should keep the higher setting you may get this way.  The goal is to have the minimum power keep the motor turning in all situations - dying batteries, vehicle is going up a ramp, anything "worst case" - while still keeping some range of speed available for axis control.  If you find you are stalling a motor frequently at low input, increase this minimum power by a few until you aren't stalling it, and then keep that higher minimum power setting (don't adjust it back down next time).  
  * Next is to adjust the motor default forward direction.  When you command a motor "forward" it should drive the vehicle forward, or drive the bed in whatever you consider "forward" (raise the bed is the default forward), etc.  If you hooked up a motor backwards, so clicking "forward" is driving it backward, simply click the toggle reversed button, and it'll flip that motor for you, so that forward is forward.
12. You should now have a fully configured vehicle you are ready to play with! Go to the Play screen via the header, or the Play Now button on the home screen, and you should be able to connect a controller to your device and control the vehicle!  The Play page is explained in more detail later on, as is the RokServer multiplayer interface.

### A note on controllers
The play page was originally written to support direct connection of a bluetooth controller to the vehicle, for easy local play once set up.  However, the ESP32-S3 and Micropython only support BLE HID controllers, which are less common.  Testing has not been thoroughly performed on that function, and it has been entirely removed for the v1 release.  The list of potentially workable controllers, as of 12/12/25, includes the following controllers:
  * Sony DualShock 4 (PS4) Controller
  * Sony DualSense (PS5) Controller
  * Xbox One S/X (Bluetooth) Controller
  * Switch Pro Controller
The expectation is that most people will use a phone, laptop, or similar to connect to the vehicle(s) and will use a gamepad connected to that device, which has much broader compatibility.  More information is available on the Play page section.  If demand is sufficient, we'll look at re-introducing local bluetooth controller connection and control in the future.


## Vehicle Hardware Conversion - FPV Camera
This conversion is mostly reversible, as other than running a few wires and maybe drilling a few holes, it doesn't impact the existing control board setup.  You will need basic soldering skills, and a willingness to take your vehicle apart, including potentially damaging it irreparably.  

1. The Vehicle Info folder contains information and pictures of the vehicles modified so far, more pictures and information will be added as we convert more vehicles.  This information may also be useful for repairs to the vehicle.

Parts used:
1x SeeedStudio XIAO ESP32-S3 Sense controller board with camera, flashed with Micropython and then the latest RokFPV release (Instructions included in a Readme.md in RokFPV)
(Wire - suggest 22 or 24ga, mounting tape or glue, solder, and other miscellanious electronics bits may be required)
(This project requires basic soldering skills)

2. Navigate to the Vehicle Info page for the vehicle you are looking to modify.  It will contain the mechanical steps and pictures needed to disassemble the vehicle.  You likely will not need to disassemble the vehicle further than removing the drive base.  For the best wire routing, you may wish however to disassemble the vehicle further to expose the best wire route.
3. A wiring diagram and list is included in the base vehicle information page, the FPV wiring is the same for each vehicle, though the vehicle specifc pages may have additional information or pictures on FPV wire routing. The wiring diagram has a separate schematic with the additions for the FPV highlighted.
  * You basically only need to connect a power and ground to the FPV board.  If you are using the stock controller board, I strongly suggest either not making this modification or adding a separate switch in-line as well to turn off the FPV controller, so you don't drain the batteries (the stock controller board uses the radio key to sleep, which currently isn't supported on using here as a sleep signal - leave a note if this is strongly desired and it could be worked out).  The easier method I'd suggest if using an FPV camera with a stock vehicle controller is to use a separate small battery such as an Anker Nano power bank to power the FPV board, and just insert those together into the front of the vehicle, which is usually sized fairly sufficiently for it.  The camera angle is able to be rotated in case you wind up using a battery pack and it makes the camera sideways or upside down.

4. After completing the hardware modifications, it is important to verify all wiring connections prior to powering on the vehicle.  Take a minute and double check your wiring against the circuit diagrams, and ensure all connections make sense (i.e. you aren't shorting the battery leads together anywhere).
5. Hopefully you flashed the FPV software onto the controller before you put it in the vehicle, otherwise dig up a usb-c cord (right angle ones are available and can be helpful if you glued yourself into a jam) and follow those instructions in the RokFPV project now.

6. On initial startup of a new FPV board, it will create a Wifi Access Point (AP) that looks like FPV-loader-XYZABC.  This network name is the tag for the vehicle, and consists of "FPV-", the vehicle type, and it's unique tag.  The default vehicle type is loader, we'll update this shortly.  Connect a phone or computer to the access point.  The default password for the access point is 1234567890.  The camera should have an IP address of 192.168.4.1, and should assign your device an IP address of 192.168.4.2.
7. Open Chrome (or an internet browser) on the device, and navigate to http://192.168.4.1, which should load the home page for the FPV Camera, and show various information about the controller.
8. Navigate to the Admin page link in the header, which will take you to a page where you can configure the general settings for the camera.  You can set the broadcast quality, bitrate, size, whether the camera should be able to sleep, the associated vehicle type, and more from this page.  Since most FPV cameras will be associated to a specific vehicle, I prefer to give it the same vehicle type as the vehicle it is providing FPV for. Select the correct vehicle type from the list.  When you select a vehicle type from the list, it will update the tag prefix as well.  I suggest keeping the same tag, but you can also set a custom tag if desired, ensure it is unique for each vehicle and FPV camera (keep the FPV- prefix).  You can also set a "friendly name" for the camera, useful to differentiate Power Sweeper 1 FPV and Power Sweeper 2 FPV if you have multiple, for example.  Click save to save your updates.  The change to the AP network name to match the new tag will NOT take effect until the vehicle is rebooted.
9. The FPV camera usually does not make sense to keep in AP mode, it's really only useful if you have a device that will ONLY be displaying the FPV stream, then you can connect that device to the vehicle's AP directly.  Most often, you will connect the FPV camera as a client of the vehicle's AP if you're running the vehicle in AP mode, or to your home network.  Either way for those, you'll use the wifi page to set the network name and password (the default vehicle AP is the tag, loader-XYZABC, and password 1234567890).  Go ahead and reboot the FPV camera to connect it to the new network.  If associated to a vehicle's AP, it will likely be assigned an IP of 192.168.4.3, or .4.2 if you haven't connected a device to the vehicle, and will be accessible to other devices on the vehicle's network.  If you're connected to your home wifi, see the notes in the vehicle conversion section about finding the FPV camera's IP and setting it to static, it's all the same. Note the IP address of the FPV camera.
  * When the FPV camera boots up, it will attempt 5 times to connect to the wifi network, if configured.  If it is unable to connect to the network, it will "fall back" to AP mode, and you will see a network with the tag of the camera, just like in step 6.  You can use this to check and correct any errors in the wifi settings.  Or also works great if you travel with the camera and need to use it away from your configured network, it will quickly fall into AP mode so you can reconfigure it that way.
NOTE: If you get stuck on a bad wifi network or set a bad static IP or similar, reboot the camera 3 times in rapid succession (less than 20 seconds between reboots), and it will force the camera into AP mode, so you can connect back and edit the wifi/IP settings.  Note that this will not clear your stored wifi network and credentials, so future reboots will still attempt to connect back to the configured network unless you make edits.
10. The FPV camera should now be connected to your network or the vehicle's network, or you are using it in AP mode.  You can re-navigate to the admin page to configure any settings for the stream, and can also (if enabled) start and shutdown the camera stream from that page.  There is also a camera testing page that will show you the output of your stream as well, so you can test.  For the most part, you won't be accessing anything on this once you get the stream/camera configured, you just need the IP address of the FPV camera to use on the vehicle or server Play pages, which has a box for you to enter that IP address.  The FPV camera IP address and "stream address" to enter on those pages is displayed prominently on the home page.




# TODO List (Project-wide)

- [ ] Remove all debug logging and print statements from all code (production cleanup)
- [ ] Refactor and clean up every class for clarity and maintainability
- [ ] Check every web page and Python file for syntax issues and errors
- [ ] Fix: Crashes in the web server cause the REPL to hang; ensure graceful error handling and recovery
- [ ] Fix: Nothing restarts gracefully after a crash; implement robust restart logic
- [ ] Fix: WiFi retry logicâ€”if WiFi fails the first time, subsequent retries immediately fail with 'WiFi Internal Error'; ensure retries are meaningful
- [ ] Add setting a password to AP mode rather than always using 1234567890
- [ ] Add a Readme.md in RokVehicle on flashing MicroPython and this program onto the board
- [ ] Add documentation in this Readme.md on the Play page, using gamepads, assigning control methodology and buttons, using axis controllers, and connecting Bluetooth gamepads directly to the vehicle
- [ ] Implement Play page
- [ ] Implement wifi scanning
- [ ] Implement direct bluetooth controller usage (BLE only)
- [ ] Test controller mapping and functionality on Play page
- [ ] FPV conversion instructions and setup
- [ ] FPV programming
- [ ] Test FPV stream integration locally on play page
- [ ] Play server instructions and setup
- [ ] FPV controls to wake and shut down the board/stream, and rotate the camera orientation 90deg in case of using a battery pack sideways